<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Conversas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ========== VARIÁVEIS CSS ========== */
    /* Alterado esquema de cores de verde para azul/branco */
    :root {
      --primary-color: #1E88E5;
      --primary-light: #42A5F5;
      --primary-dark: #1565C0;
      --accent-color: #2196F3;
      --sent-message-bg: #E3F2FD;
      --received-message-bg: #FFFFFF;
      --bg-color: #F5F7FA;
      --sidebar-bg: #FFFFFF;
      --header-bg: #FAFAFA;
      --border-color: #E0E0E0;
      --text-primary: #212121;
      --text-secondary: #616161;
      --text-muted: #9E9E9E;
      --shadow: 0 1px 3px rgba(0,0,0,0.12);
      --shadow-lg: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* ========== RESET E BASE ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.5;
    }

    /* ========== ACESSIBILIDADE ========== */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    *:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* ========== ESTRUTURA PRINCIPAL ========== */
    .tab-content {
      max-width: 1400px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-color);
    }

    .page-header {
      background: var(--primary-color);
      color: white;
      padding: 20px 24px;
      box-shadow: var(--shadow);
    }

    .page-header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .page-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    /* ========== ESTADO VAZIO ========== */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 120px);
      color: var(--text-muted);
      text-align: center;
      padding: 20px;
    }

    .empty-state i {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 22px;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .empty-state p {
      font-size: 14px;
    }

    /* ========== CONTAINER DO CHAT ========== */
    #chat-container {
      display: grid;
      grid-template-columns: 380px 1fr;
      height: calc(100vh - 120px);
      background: white;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    /* ========== LISTA DE CONTATOS ========== */
    #contact-list {
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .contact-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s ease;
      position: relative;
    }

    .contact-item:hover {
      background: var(--bg-color);
    }

    .contact-item.active {
      background: var(--bg-color);
    }

    .contact-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary-light);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
      margin-right: 12px;
    }

    .contact-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .contact-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .contact-name {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .contact-time {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .contact-preview {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contact-last-message {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .unread-badge {
      background: var(--accent-color);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
      margin-left: 8px;
    }

    /* ========== PAINEL DE CONVERSA ========== */
    #chat-box {
      display: flex;
      flex-direction: column;
      background: #FAFAFA;
      position: relative;
    }

    /* Header do chat */
    #chat-header {
      background: var(--header-bg);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      box-shadow: var(--shadow);
      z-index: 10;
      border-bottom: 1px solid var(--border-color);
    }

    .back-button {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      margin-right: 12px;
      padding: 4px;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-light);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      margin-right: 12px;
    }

    .chat-contact-name {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Área de mensagens */
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: white;
    }

    /* Mensagens */
    .message {
      display: flex;
      margin-bottom: 4px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.sent {
      justify-content: flex-end;
    }

    .message.received {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 65%;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      position: relative;
      word-wrap: break-word;
    }

    .message.sent .message-bubble {
      background: var(--sent-message-bg);
      border-bottom-right-radius: 2px;
      border: 1px solid #BBDEFB;
    }

    .message.received .message-bubble {
      background: var(--received-message-bg);
      border-bottom-left-radius: 2px;
      border: 1px solid var(--border-color);
    }

    .message-text {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
      margin-top: 4px;
    }

    /* Área de input */
    #chat-input-area {
      background: var(--header-bg);
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      align-items: center;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.08);
      border-top: 1px solid var(--border-color);
    }

    #inputMensagem {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 24px;
      font-size: 15px;
      background: white;
      color: var(--text-primary);
      outline: none;
      transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }

    #inputMensagem:focus {
      border-color: var(--primary-light);
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
    }

    #chat-input-area button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    #chat-input-area button:hover {
      background: var(--primary-dark);
    }

    #chat-input-area button:active {
      transform: scale(0.98);
    }

    /* ========== RESPONSIVIDADE MOBILE ========== */
    @media (max-width: 768px) {
      #chat-container {
        grid-template-columns: 1fr;
      }

      #contact-list {
        display: flex;
      }

      #chat-box {
        display: none;
      }

      #chat-container.chat-open #contact-list {
        display: none;
      }

      #chat-container.chat-open #chat-box {
        display: flex;
      }

      .back-button {
        display: block !important;
      }

      .message-bubble {
        max-width: 80%;
      }

      .page-header {
        padding: 16px 20px;
      }

      .page-header h1 {
        font-size: 20px;
      }
    }

    /* ========== SCROLLBAR CUSTOMIZADA ========== */
    #contact-list::-webkit-scrollbar,
    #chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    #contact-list::-webkit-scrollbar-track,
    #chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #contact-list::-webkit-scrollbar-thumb,
    #chat-messages::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
    }

    #contact-list::-webkit-scrollbar-thumb:hover,
    #chat-messages::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<section class="tab-content" id="conversations-tab">
  <div class="page-header">
    <h1>Conversas</h1>
    <p>Suas conversas com supervisores</p>
  </div>

  <div class="empty-state" id="conversations-empty-state">
    <i class="fas fa-comments"></i>
    <h3>Nenhuma conversa iniciada</h3>
    <p>Suas conversas com supervisores aparecerão aqui</p>
  </div>

  <div id="chat-container" style="display:none;">
    <div id="contact-list"></div>
    <div id="chat-box">
      <div id="chat-header"></div>
      <div id="chat-messages" aria-live="polite" aria-atomic="false"></div>
      <div id="chat-input-area" style="display:none;">
        <label for="inputMensagem" class="visually-hidden">Digite sua mensagem</label>
        <input type="text" id="inputMensagem" placeholder="Digite uma mensagem..." />
        <button onclick="enviarMensagem()">Enviar</button>
      </div>
    </div>
  </div>
</section>

<script>
  // ========== CONFIGURAÇÃO DA API ==========
  const API_BASE = 'https://sua-api.com/api'; // Altere para sua URL de API
  const SUPERVISOR_ID = 1; // ID do supervisor logado
  const USE_MOCK_DATA = true; // Altere para false quando conectar à API real

  // ========== VARIÁVEIS GLOBAIS ==========
  let conversas = [];
  let conversaAtualId = null;
  let psicologos = []; // Lista de psicólogos (pode vir de outra API)
  let solicitacoes = []; // Solicitações aceitas

  // ========== DADOS MOCKADOS (para desenvolvimento) ==========
  const mockPsicologos = [
    { id: 1, nome: 'Carlos Silva' },
    { id: 2, nome: 'Ana Paula' },
    { id: 3, nome: 'Roberto Mendes' },
    { id: 4, nome: 'Mariana Costa' },
    { id: 5, nome: 'Fernando Alves' }
  ];

  const mockSolicitacoes = [
    { psicologoId: 1, status: 'ACEITA' },
    { psicologoId: 2, status: 'ACEITA' },
    { psicologoId: 3, status: 'ACEITA' },
    { psicologoId: 4, status: 'ACEITA' },
    { psicologoId: 5, status: 'ACEITA' }
  ];

  const mockMensagens = {
    1: [
      { id: 1, remetenteId: 1, destinatarioId: SUPERVISOR_ID, conteudo: 'Olá! Como está o andamento do projeto?', dataEnvio: '2025-01-03T09:30:00', lida: true },
      { id: 2, remetenteId: SUPERVISOR_ID, destinatarioId: 1, conteudo: 'Está indo bem! Já finalizei 80% das tarefas.', dataEnvio: '2025-01-03T09:32:00', lida: true },
      { id: 3, remetenteId: 1, destinatarioId: SUPERVISOR_ID, conteudo: 'Ótimo trabalho! Continue assim.', dataEnvio: '2025-01-03T09:35:00', lida: false }
    ],
    2: [
      { id: 4, remetenteId: 2, destinatarioId: SUPERVISOR_ID, conteudo: 'Bom dia! Preciso do relatório até amanhã.', dataEnvio: '2025-01-03T08:15:00', lida: true },
      { id: 5, remetenteId: SUPERVISOR_ID, destinatarioId: 2, conteudo: 'Bom dia! Pode deixar, vou enviar hoje.', dataEnvio: '2025-01-03T08:20:00', lida: true },
      { id: 6, remetenteId: 2, destinatarioId: SUPERVISOR_ID, conteudo: 'Aguardo o envio então!', dataEnvio: '2025-01-03T10:45:00', lida: false }
    ],
    3: [
      { id: 7, remetenteId: 3, destinatarioId: SUPERVISOR_ID, conteudo: 'Você pode revisar o documento que enviei?', dataEnvio: '2025-01-02T16:45:00', lida: true },
      { id: 8, remetenteId: SUPERVISOR_ID, destinatarioId: 3, conteudo: 'Claro! Vou revisar agora.', dataEnvio: '2025-01-02T16:50:00', lida: true },
      { id: 9, remetenteId: 3, destinatarioId: SUPERVISOR_ID, conteudo: 'Obrigado!', dataEnvio: '2025-01-02T16:52:00', lida: true }
    ],
    4: [
      { id: 10, remetenteId: 4, destinatarioId: SUPERVISOR_ID, conteudo: 'Reunião confirmada para segunda às 14h.', dataEnvio: '2025-01-01T11:20:00', lida: true },
      { id: 11, remetenteId: SUPERVISOR_ID, destinatarioId: 4, conteudo: 'Perfeito! Estarei lá.', dataEnvio: '2025-01-01T11:25:00', lida: true }
    ],
    5: [
      { id: 12, remetenteId: 5, destinatarioId: SUPERVISOR_ID, conteudo: 'Parabéns pelo desempenho este mês!', dataEnvio: '2024-12-30T17:00:00', lida: true },
      { id: 13, remetenteId: SUPERVISOR_ID, destinatarioId: 5, conteudo: 'Muito obrigado! Vou continuar me dedicando.', dataEnvio: '2024-12-30T17:05:00', lida: true },
      { id: 14, remetenteId: 5, destinatarioId: SUPERVISOR_ID, conteudo: 'Conte comigo para o próximo projeto!', dataEnvio: '2025-01-03T14:30:00', lida: false },
      { id: 15, remetenteId: 5, destinatarioId: SUPERVISOR_ID, conteudo: 'Quando podemos conversar sobre isso?', dataEnvio: '2025-01-03T14:32:00', lida: false }
    ]
  };

  // ========== INICIALIZAÇÃO ==========
  document.addEventListener('DOMContentLoaded', () => {
    carregarConversas();
    
    // Adicionar listener para Enter no input
    document.getElementById('inputMensagem').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        enviarMensagem();
      }
    });

    // Atualizar mensagens a cada 5 segundos se conversa aberta
    setInterval(async () => {
      if (conversaAtualId !== null) {
        await atualizarMensagensAtual();
      }
    }, 5000);
  });

  // ========== CARREGAMENTO DE CONVERSAS ==========
  async function carregarConversas() {
    try {
      if (USE_MOCK_DATA) {
        // Modo mock: usar dados de exemplo
        psicologos = mockPsicologos;
        solicitacoes = mockSolicitacoes;
        
        const aceitas = solicitacoes.filter(s => s.status === "ACEITA");
        
        conversas = aceitas.map((s) => {
          const psicologoId = s.psicologoId;
          const mensagens = mockMensagens[psicologoId] || [];
          const psicologo = psicologos.find(p => p.id === psicologoId) || {};
          const ultimaMsg = mensagens.length > 0 ? mensagens[mensagens.length - 1].conteudo : "Conversa iniciada";
          const ultimaData = mensagens.length > 0 ? mensagens[mensagens.length - 1].dataEnvio : new Date().toISOString();
          
          return {
            psicologoId,
            psicologoNome: psicologo.nome || `Psicólogo #${psicologoId}`,
            mensagens,
            ultimaMensagem: ultimaMsg,
            timestamp: ultimaData,
            naoLida: mensagens.filter(m => !m.lida && m.remetenteId === psicologoId).length,
          };
        });
      } else {
        // Modo produção: buscar da API
        const aceitas = solicitacoes.filter(s => s.status === "ACEITA");
        
        conversas = await Promise.all(
          aceitas.map(async (s) => {
            const psicologoId = s.psicologoId;
            const resMsgs = await fetch(`${API_BASE}/mensagens/${SUPERVISOR_ID}/${psicologoId}`);
            const mensagens = await resMsgs.json();

            const psicologo = psicologos.find(p => p.id === psicologoId) || {};
            const ultimaMsg = mensagens.length > 0 ? mensagens[mensagens.length - 1].conteudo : "Conversa iniciada";
            const ultimaData = mensagens.length > 0 ? mensagens[mensagens.length - 1].dataEnvio : new Date().toISOString();

            return {
              psicologoId,
              psicologoNome: psicologo.nome || `Psicólogo #${psicologoId}`,
              mensagens,
              ultimaMensagem: ultimaMsg,
              timestamp: ultimaData,
              naoLida: mensagens.filter(m => !m.lida && m.remetenteId === psicologoId).length,
            };
          })
        );
      }

      renderConversas();
    } catch (err) {
      console.error("Erro ao carregar conversas:", err);
    }
  }

  // ========== RENDERIZAÇÃO DE CONVERSAS ==========
  function renderConversas() {
    const emptyState = document.getElementById("conversations-empty-state");
    const chatContainer = document.getElementById("chat-container");
    const contactList = document.getElementById("contact-list");

    if (conversas.length === 0) {
      emptyState.style.display = "flex";
      chatContainer.style.display = "none";
      return;
    }

    emptyState.style.display = "none";
    chatContainer.style.display = "grid";

    contactList.innerHTML = "";

    conversas.forEach((conversa) => {
      const div = document.createElement("div");
      div.className = "contact-item";
      if (conversa.psicologoId === conversaAtualId) {
        div.classList.add("active");
      }
      
      const avatar = obterIniciais(conversa.psicologoNome);
      const horarioFormatado = formatDate(conversa.timestamp);
      const badgeHTML = conversa.naoLida > 0 
        ? `<span class="unread-badge">${conversa.naoLida}</span>` 
        : '';

      div.innerHTML = `
        <div class="contact-avatar">${avatar}</div>
        <div class="contact-info">
          <div class="contact-header">
            <span class="contact-name">${conversa.psicologoNome}</span>
            <span class="contact-time">${horarioFormatado}</span>
          </div>
          <div class="contact-preview">
            <span class="contact-last-message">${conversa.ultimaMensagem}</span>
            ${badgeHTML}
          </div>
        </div>
      `;
      
      div.onclick = () => abrirConversa(conversa);
      div.setAttribute('role', 'button');
      div.setAttribute('tabindex', '0');
      div.onkeypress = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          abrirConversa(conversa);
        }
      };
      
      contactList.appendChild(div);
    });
  }

  // ========== ABRIR CONVERSA ==========
  async function abrirConversa(conversa) {
    conversaAtualId = conversa.psicologoId;
    
    // Marcar mensagens como lidas
    conversa.naoLida = 0;
    
    // Atualizar header
    const avatar = obterIniciais(conversa.psicologoNome);
    document.getElementById("chat-header").innerHTML = `
      <button class="back-button" onclick="voltarParaLista()" aria-label="Voltar para lista de contatos">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="chat-avatar">${avatar}</div>
      <span class="chat-contact-name">${conversa.psicologoNome}</span>
    `;
    
    document.getElementById("chat-input-area").style.display = "flex";

    try {
      let mensagens;
      
      if (USE_MOCK_DATA) {
        // Modo mock
        mensagens = mockMensagens[conversa.psicologoId] || [];
      } else {
        // Modo produção
        const res = await fetch(`${API_BASE}/mensagens/${SUPERVISOR_ID}/${conversa.psicologoId}`);
        mensagens = await res.json();
      }

      const messagesContainer = document.getElementById("chat-messages");
      messagesContainer.innerHTML = "";

      if (mensagens.length === 0) {
        messagesContainer.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted);">
          Conversa com ${conversa.psicologoNome}
        </div>`;
      } else {
        mensagens.forEach((msg) => {
          const div = document.createElement("div");
          div.className = msg.remetenteId === SUPERVISOR_ID ? "message sent" : "message received";

          const data = new Date(msg.dataEnvio || msg.data || msg.createdAt || Date.now());
          const horarioCompleto = formatarHorarioCompleto(data);

          div.innerHTML = `
            <div class="message-bubble">
              <div class="message-text">${msg.conteudo}</div>
              <div class="message-time">${horarioCompleto}</div>
            </div>
          `;

          messagesContainer.appendChild(div);
        });
        
        // Scroll para o final
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // Mobile: mostrar chat
      document.getElementById('chat-container').classList.add('chat-open');
      
      // Focar no input
      document.getElementById('inputMensagem').focus();
      
      // Atualizar lista de contatos
      renderConversas();
      
    } catch (err) {
      console.error("Erro ao abrir conversa:", err);
    }
  }

  // ========== ENVIAR MENSAGEM ==========
  async function enviarMensagem() {
    const input = document.getElementById("inputMensagem");
    const texto = input.value.trim();

    if (!texto || conversaAtualId === null) return;

    const novaMensagem = {
      remetenteId: SUPERVISOR_ID,
      destinatarioId: conversaAtualId,
      conteudo: texto,
      lida: false,
      dataEnvio: new Date().toISOString()
    };

    try {
      if (USE_MOCK_DATA) {
        // Modo mock: adicionar localmente
        if (!mockMensagens[conversaAtualId]) {
          mockMensagens[conversaAtualId] = [];
        }
        novaMensagem.id = Date.now();
        mockMensagens[conversaAtualId].push(novaMensagem);
        
        // Atualizar conversa local
        const conversa = conversas.find(c => c.psicologoId === conversaAtualId);
        if (conversa) {
          conversa.mensagens.push(novaMensagem);
          conversa.ultimaMensagem = novaMensagem.conteudo;
          conversa.timestamp = novaMensagem.dataEnvio;
        }
        
        abrirConversa(conversa);
        
        // Simular resposta automática
        setTimeout(() => {
          simularResposta();
        }, 1000 + Math.random() * 1000);
        
      } else {
        // Modo produção: enviar para API
        const res = await fetch(`${API_BASE}/mensagens`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(novaMensagem),
        });
        
        if (!res.ok) throw new Error("Falha ao enviar mensagem");

        const msgEnviada = await res.json();

        const conversa = conversas.find(c => c.psicologoId === conversaAtualId);
        if (conversa) {
          conversa.mensagens.push(msgEnviada);
          conversa.ultimaMensagem = msgEnviada.conteudo;
          conversa.timestamp = msgEnviada.dataEnvio || new Date().toISOString();
        }

        abrirConversa(conversa);
      }

      input.value = "";
      input.focus();
      
    } catch (err) {
      alert("Erro ao enviar mensagem.");
      console.error(err);
    }
  }

  // ========== SIMULAR RESPOSTA AUTOMÁTICA (apenas modo mock) ==========
  function simularResposta() {
    if (!USE_MOCK_DATA) return;
    
    const respostas = [
      'Entendido!',
      'Perfeito, obrigado!',
      'Vou verificar isso.',
      'Pode deixar comigo.',
      'Ótimo trabalho!',
      'Combinado!',
      'Vou te retornar em breve.',
      'Excelente!'
    ];

    const respostaAleatoria = respostas[Math.floor(Math.random() * respostas.length)];

    const respostaMensagem = {
      id: Date.now(),
      remetenteId: conversaAtualId,
      destinatarioId: SUPERVISOR_ID,
      conteudo: respostaAleatoria,
      dataEnvio: new Date().toISOString(),
      lida: false
    };

    if (!mockMensagens[conversaAtualId]) {
      mockMensagens[conversaAtualId] = [];
    }
    mockMensagens[conversaAtualId].push(respostaMensagem);

    const conversa = conversas.find(c => c.psicologoId === conversaAtualId);
    if (conversa) {
      conversa.mensagens.push(respostaMensagem);
      conversa.ultimaMensagem = respostaMensagem.conteudo;
      conversa.timestamp = respostaMensagem.dataEnvio;
      
      // Incrementar badge apenas se chat não estiver aberto
      const chatAberto = document.getElementById('chat-container').classList.contains('chat-open');
      if (!chatAberto) {
        conversa.naoLida++;
      }
      
      // Atualizar interface
      const messagesContainer = document.getElementById("chat-messages");
      const div = document.createElement("div");
      div.className = "message received";
      
      const horarioCompleto = formatarHorarioCompleto(new Date(respostaMensagem.dataEnvio));
      
      div.innerHTML = `
        <div class="message-bubble">
          <div class="message-text">${respostaMensagem.conteudo}</div>
          <div class="message-time">${horarioCompleto}</div>
        </div>
      `;
      
      messagesContainer.appendChild(div);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      renderConversas();
    }
  }

  // ========== ATUALIZAR MENSAGENS ATUAL ==========
  async function atualizarMensagensAtual() {
    if (conversaAtualId === null || USE_MOCK_DATA) return;
    
    try {
      const res = await fetch(`${API_BASE}/mensagens/${SUPERVISOR_ID}/${conversaAtualId}`);
      if (!res.ok) throw new Error("Erro ao buscar mensagens");
      const mensagens = await res.json();

      const conversa = conversas.find(c => c.psicologoId === conversaAtualId);
      if (conversa) {
        conversa.mensagens = mensagens;
        abrirConversa(conversa);
      }
    } catch (err) {
      console.error("Erro ao atualizar mensagens:", err);
    }
  }

  // ========== VOLTAR PARA LISTA (MOBILE) ==========
  function voltarParaLista() {
    document.getElementById('chat-container').classList.remove('chat-open');
  }

  // ========== UTILITÁRIOS ==========
  function obterIniciais(nome) {
    const palavras = nome.split(' ');
    if (palavras.length >= 2) {
      return (palavras[0][0] + palavras[1][0]).toUpperCase();
    }
    return nome.substring(0, 2).toUpperCase();
  }

  function formatDate(dateString) {
    const data = new Date(dateString);
    const agora = new Date();
    const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
    const dataMsg = new Date(data.getFullYear(), data.getMonth(), data.getDate());

    const horas = data.getHours().toString().padStart(2, '0');
    const minutos = data.getMinutes().toString().padStart(2, '0');

    if (dataMsg.getTime() === hoje.getTime()) {
      return `${horas}:${minutos}`;
    } else {
      const dia = data.getDate().toString().padStart(2, '0');
      const mes = (data.getMonth() + 1).toString().padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }
  }

  function formatarHorarioCompleto(data) {
    const agora = new Date();
    const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
    const dataMsg = new Date(data.getFullYear(), data.getMonth(), data.getDate());

    const horas = data.getHours().toString().padStart(2, '0');
    const minutos = data.getMinutes().toString().padStart(2, '0');

    if (dataMsg.getTime() === hoje.getTime()) {
      return `Hoje • ${horas}:${minutos}`;
    } else {
      const dia = data.getDate().toString().padStart(2, '0');
      const mes = (data.getMonth() + 1).toString().padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano} • ${horas}:${minutos}`;
    }
  }
</script>

</body>
</html>
